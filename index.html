<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام مواعيد المركز</title>
  <style>
    /* ===== ألوان الهوية ===== */
    :root {
      --dark: #142445;
      --accent: #8bd5c8;
      --bg: #f9f1e5;
      --text: #333;
    }
    body { margin:0; font-family:'Tajawal',sans-serif; background:var(--bg); color:var(--text); }
    header { background:var(--dark); color:#fff; display:flex; align-items:center; padding:10px; }
    header img { height:40px; margin-left:10px; }
    header h1 { font-size:1.5rem; }
    nav { display:flex; background:#fff; border-bottom:2px solid var(--accent); }
    nav button { flex:1; padding:10px; border:none; background:none; cursor:pointer; color:var(--dark); }
    nav button.active, nav button:hover { background:var(--accent); }
    section { display:none; padding:20px; }
    section.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:var(--accent); }
    button { padding:6px 12px; margin:4px; cursor:pointer; }
    /* مودال مركزي */
    #modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
    #modal .content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; }
    #modal label { display:block; margin:8px 0; }
    #modal input, #modal select { width:100%; padding:6px; }
  </style>
</head>
<body>

  <header>
    <img src="https://via.placeholder.com/200x40?text=شعار+المركز" alt="شعار المركز">
    <h1>نظام مواعيد المركز</h1>
  </header>

  <nav>
    <button data-tab="children" class="active">الأطفال</button>
    <button data-tab="specialists">الأخصائيون</button>
    <button data-tab="appointments">المواعيد</button>
    <button data-tab="reports">التقارير</button>
  </nav>

  <!-- 1) إدارة الأطفال -->
  <section id="children" class="active">
    <h2>١. إدارة الأطفال</h2>
    <button onclick="openModal('child')">إضافة طفل</button>
    <table id="tblChildren">
      <thead>
        <tr><th>#</th><th>اسم</th><th>بكيج</th><th>بدء</th><th>كلي</th><th>متبقي</th><th>حالة</th><th>إجراءات</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 2) إدارة الأخصائيين -->
  <section id="specialists">
    <h2>٢. إدارة الأخصائيين</h2>
    <button onclick="openModal('spec')">إضافة أخصائي</button>
    <table id="tblSpecs">
      <thead>
        <tr><th>#</th><th>اسم</th><th>قسم</th><th>أيام</th><th>إجراءات</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 3) حجز المواعيد -->
  <section id="appointments">
    <h2>٣. حجز المواعيد</h2>
    <button onclick="autoScheduleAll()">جدولة تلقائية</button>
    <table id="tblAppts">
      <thead>
        <tr>
          <th>#</th><th>طفل</th><th>تاريخ</th><th>وقت</th>
          <th>قسم</th><th>أخصائي</th><th>نوع</th><th>حالة</th><th>إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 4) التقارير -->
  <section id="reports">
    <h2>٤. التقارير</h2>
    <div id="endingReport"></div>
    <div id="pausedReport"></div>
  </section>

  <!-- المودال الموحد -->
  <div id="modal">
    <div class="content">
      <h3 id="modalTitle"></h3>
      <form id="modalForm"></form>
      <div style="text-align:left; margin-top:10px;">
        <button onclick="saveModal(event)">حفظ</button>
        <button onclick="closeModal(event)">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
  /** ------ التخزين المحلي ------ **/
  const S = {
    children: JSON.parse(localStorage.getItem('children')||'{}'),
    specialists: JSON.parse(localStorage.getItem('specialists')||'{}'),
    appointments: JSON.parse(localStorage.getItem('appointments')||'{}'),
  };
  const packages = {
    "24":{weekly:2,total:24,days:["Saturday","Wednesday"]},
    "36":{weekly:3,total:36,days:["Saturday","Monday","Thursday"]},
    "48":{weekly:4,total:48,days:["Saturday","Monday","Wednesday","Friday"]},
    "psychology":{weekly:1,total:1,days:["Saturday"]},
    "iq":{weekly:1,total:1,days:["Saturday"]}
  };
  const slots=["13:00","15:20","17:40"];
  function sync(){ 
    localStorage.setItem('children',JSON.stringify(S.children));
    localStorage.setItem('specialists',JSON.stringify(S.specialists));
    localStorage.setItem('appointments',JSON.stringify(S.appointments));
  }

  /** ------ تبويبات ------ **/
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  $$( 'nav button').forEach(b=>{
    b.onclick=()=>{
      $$('nav button').forEach(x=>x.classList.remove('active'));
      $$('section').forEach(sec=>sec.classList.remove('active'));
      b.classList.add('active');
      $('#'+b.dataset.tab).classList.add('active');
      if(b.dataset.tab==='reports') renderReports();
    };
  });

  /** ------ إعادة العرض ------ **/
  function renderChildren(){
    let tb=$('#tblChildren tbody'); tb.innerHTML='';
    Object.entries(S.children).forEach(([id,ch],i)=>{
      tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${ch.name}</td><td>${ch.package}</td><td>${ch.startDate}</td>
        <td>${packages[ch.package].total}</td><td>${ch.remaining}</td><td>${ch.status}</td>
        <td>
          <button onclick="openModal('child','${id}')">تعديل</button>
          <button onclick="deleteChild('${id}')">حذف</button>
        </td>
      </tr>`;
    });
  }
  function renderSpecs(){
    let tb=$('#tblSpecs tbody'); tb.innerHTML='';
    Object.entries(S.specialists).forEach(([id,sp],i)=>{
      tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${sp.name}</td><td>${sp.section}</td><td>${sp.workingDays.join(',')}</td>
        <td>
          <button onclick="openModal('spec','${id}')">تعديل</button>
          <button onclick="deleteSpec('${id}')">حذف</button>
        </td>
      </tr>`;
    });
  }
  function renderAppts(){
    let tb=$('#tblAppts tbody'); tb.innerHTML='';
    Object.entries(S.appointments).forEach(([id,a],i)=>{
      let ch=S.children[a.childId]?.name||'–';
      let sp=S.specialists[a.specId]?.name||'–';
      tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${ch}</td><td>${a.date}</td><td>${a.time}</td>
        <td>${a.section}</td><td>${sp}</td><td>${a.type}</td><td>${a.status}</td>
        <td>
          ${a.status==='scheduled'?`<button onclick="markAbsent('${id}')">غاب</button>`:''}
          <button onclick="openModal('appt','${id}')">تعديل</button>
          <button onclick="deleteAppt('${id}')">حذف</button>
          ${a.status==='absent'?`<button onclick="makeup('${id}')">تعويض</button>`:''}
        </td>
      </tr>`;
    });
  }
  function renderReports(){
    let end=Object.values(S.children)
      .filter(c=>c.status==='active'&&c.remaining<=packages[c.package].weekly)
      .map(c=>`<li>${c.name} (${c.remaining})</li>`).join('')||'<li>لا أحد</li>';
    let paused=Object.values(S.children)
      .filter(c=>c.status==='paused')
      .map(c=>`<li>${c.name}</li>`).join('')||'<li>لا أحد</li>';
    $('#endingReport').innerHTML=`<h3>قريب الانتهاء:</h3><ul>${end}</ul>`;
    $('#pausedReport').innerHTML=`<h3>متوقفون:</h3><ul>${paused}</ul>`;
  }

  /** ------ CRUD ------ **/
  function deleteChild(id){
    if(!confirm('حذف طفل؟'))return;
    delete S.children[id]; sync(); renderChildren();
  }
  function deleteSpec(id){
    if(!confirm('حذف أخصائي؟'))return;
    delete S.specialists[id]; sync(); renderSpecs();
  }
  function deleteAppt(id){
    if(!confirm('حذف موعد؟'))return;
    let a=S.appointments[id];
    if(a.type==='regular') S.children[a.childId].remaining++;
    delete S.appointments[id]; sync(); renderAppts(); renderChildren();
  }
  function markAbsent(id){
    S.appointments[id].status='absent';
    S.children[S.appointments[id].childId].remaining++;
    sync(); renderAppts(); renderChildren();
  }
  function makeup(id){ autoScheduleChild(S.appointments[id].childId,{type:'makeup'}); }

  /** ------ مودال ------ **/
  let mType,mId;
  function openModal(type,id=null){
    mType=type; mId=id;
    $('#modalTitle').innerText=(id?'تعديل ':'إضافة ')+{child:'طفل',spec:'أخصائي',appt:'موعد'}[type];
    let f=$('#modalForm'); f.innerHTML='';
    let d=id?(type==='child'?S.children[id]:(type==='spec'?S.specialists[id]:S.appointments[id])):{};
    if(type==='child'){
      f.innerHTML=`
        <label>اسم: <input name="name" value="${d.name||''}"/></label>
        <label>بكيج:
          <select name="package">
            ${Object.keys(packages).map(k=>`<option ${k===d.package?'selected':''} value="${k}">${k}</option>`).join('')}
          </select>
        </label>
        <label>بدء: <input type="date" name="startDate" value="${d.startDate||''}"/></label>
        <label>حالة:
          <select name="status">
            <option ${d.status==='active'?'selected':''} value="active">نشط</option>
            <option ${d.status==='paused'?'selected':''} value="paused">متوقف</option>
          </select>
        </label>`;
    }
    if(type==='spec'){
      f.innerHTML=`
        <label>اسم: <input name="name" value="${d.name||''}"/></label>
        <label>قسم:
          <select name="section">
            <option value="speech">تخاطب</option>
            <option value="behavior">سلوك</option>
            <option value="skills">مهارات</option>
            <option value="psychology">نفسية</option>
            <option value="iq">ذكاء</option>
          </select>
        </label>
        <label>أيام (مثل: Saturday,Monday):
          <input name="workingDays" value="${(d.workingDays||[]).join(',')}"/>
        </label>`;
    }
    if(type==='appt'){
      f.innerHTML=`
        <label>طفل:
          <select name="childId">
            ${Object.entries(S.children).map(([cid,ch])=>`<option ${cid===d.childId?'selected':''} value="${cid}">${ch.name}</option>`).join('')}
          </select>
        </label>
        <label>قسم:
          <select name="section">
            ${Object.keys(packages).map(k=>`<option ${k===d.section?'selected':''} value="${k}">${k}</option>`).join('')}
          </select>
        </label>
        <label>تاريخ: <input type="date" name="date" value="${d.date||''}"/></label>
        <label>وقت:
          <select name="time">
            ${slots.map(t=>`<option ${t===d.time?'selected':''} value="${t}">${t}</option>`).join('')}
          </select>
        </label>
        <label>نوع:
          <select name="type">
            <option ${d.type==='regular'?'selected':''} value="regular">عادي</option>
            <option ${d.type==='makeup'?'selected':''} value="makeup">تعويض</option>
          </select>
        </label>`;
    }
    $('#modal').style.display='flex';
  }
  function closeModal(e){ e.preventDefault(); $('#modal').style.display='none'; }
  function saveModal(e){
    e.preventDefault();
    let fm=new FormData($('#modalForm')), o={};
    for(let [k,v] of fm.entries()) o[k]=v;
    if(mType==='child'){
      if(!mId){ mId=Date.now().toString(); o.remaining=packages[o.package].total; }
      S.children[mId]=o; renderChildren();
    }
    if(mType==='spec'){
      if(!mId) mId=Date.now().toString();
      o.workingDays=o.workingDays.split(',').map(x=>x.trim());
      S.specialists[mId]=o; renderSpecs();
    }
    if(mType==='appt'){
      if(!mId){
        mId=Date.now().toString();
        if(o.type==='regular') S.children[o.childId].remaining--;
      }
      S.appointments[mId]={...o,status:'scheduled'}; renderAppts(); renderChildren();
    }
    sync(); closeModal(e);
  }

  /** ------ الجدولة التلقائية ------ **/
  function nextDate(day){
    const map={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};
    let t=new Date(), d=(map[day]-t.getDay()+7)%7||7;
    let r=new Date(t.getFullYear(),t.getMonth(),t.getDate()+d);
    return r.toISOString().split('T')[0];
  }
  function autoScheduleChild(cid,opts={type:'regular'}){
    let ch=S.children[cid], pkg=packages[ch.package], need=pkg.weekly;
    for(let day of pkg.days){
      if(need===0)break;
      let date=nextDate(day);
      for(let time of slots){
        if(need===0)break;
        let entry=Object.entries(S.specialists).find(([i,sp])=>sp.section===ch.package && sp.workingDays.includes(day));
        if(!entry) continue;
        let [spid]=entry;
        if(Object.values(S.appointments).some(a=>a.specId===spid && a.date===date && a.time===time)) continue;
        let aid=Date.now().toString()+Math.random();
        S.appointments[aid]={childId:cid,specId:spid,section:ch.package,date,time,type:opts.type,status:'scheduled'};
        if(opts.type==='regular'){ ch.remaining--; need--; }
      }
    }
    sync(); renderAppts(); renderChildren();
  }
  function autoScheduleAll(){
    Object.keys(S.children).forEach(cid=>{
      if(S.children[cid].status==='active') autoScheduleChild(cid);
    });
  }

  // بدء العرض
  renderChildren(); renderSpecs(); renderAppts();
  </script>

</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام مواعيد المركز</title>
  <style>
    /* ===== ألوان الهوية ===== */
    :root {
      --dark: #142445;
      --accent: #8bd5c8;
      --bg: #f9f1e5;
      --text: #333;
    }
    body { margin:0; font-family:'Tajawal',sans-serif; background:var(--bg); color:var(--text); }
    header { background:var(--dark); color:#fff; display:flex; align-items:center; padding:10px; }
    header img { height:40px; margin-left:10px; }
    header h1 { font-size:1.5rem; }
    nav { display:flex; background:#fff; border-bottom:2px solid var(--accent); }
    nav button { flex:1; padding:10px; border:none; background:none; cursor:pointer; color:var(--dark); }
    nav button.active, nav button:hover { background:var(--accent); }
    section { display:none; padding:20px; }
    section.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:var(--accent); }
    button { padding:6px 12px; margin:4px; cursor:pointer; }
    /* مودال مركزي */
    #modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
    #modal .content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; }
    #modal label { display:block; margin:8px 0; }
    #modal input, #modal select { width:100%; padding:6px; }
  </style>
</head>
<body>

  <header>
    <img src="https://via.placeholder.com/200x40?text=شعار+المركز" alt="شعار المركز">
    <h1>نظام مواعيد المركز</h1>
  </header>

  <nav>
    <button data-tab="children" class="active">الأطفال</button>
    <button data-tab="specialists">الأخصائيون</button>
    <button data-tab="appointments">المواعيد</button>
    <button data-tab="reports">التقارير</button>
  </nav>

  <!-- 1) إدارة الأطفال -->
  <section id="children" class="active">
    <h2>١. إدارة الأطفال</h2>
    <button onclick="openModal('child')">إضافة طفل</button>
    <table id="tblChildren">
      <thead>
        <tr><th>#</th><th>اسم</th><th>بكيج</th><th>بدء</th><th>كلي</th><th>متبقي</th><th>حالة</th><th>إجراءات</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 2) إدارة الأخصائيين -->
  <section id="specialists">
    <h2>٢. إدارة الأخصائيين</h2>
    <button onclick="openModal('spec')">إضافة أخصائي</button>
    <table id="tblSpecs">
      <thead>
        <tr><th>#</th><th>اسم</th><th>قسم</th><th>أيام</th><th>إجراءات</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 3) حجز المواعيد -->
  <section id="appointments">
    <h2>٣. حجز المواعيد</h2>
    <button onclick="autoScheduleAll()">جدولة تلقائية</button>
    <table id="tblAppts">
      <thead>
        <tr>
          <th>#</th><th>طفل</th><th>تاريخ</th><th>وقت</th>
          <th>قسم</th><th>أخصائي</th><th>نوع</th><th>حالة</th><th>إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- 4) التقارير -->
  <section id="reports">
    <h2>٤. التقارير</h2>
    <div id="endingReport"></div>
    <div id="pausedReport"></div>
  </section>

  <!-- المودال الموحد -->
  <div id="modal">
    <div class="content">
      <h3 id="modalTitle"></h3>
      <form id="modalForm"></form>
      <div style="text-align:left; margin-top:10px;">
        <button onclick="saveModal(event)">حفظ</button>
        <button onclick="closeModal(event)">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
  /** ------ التخزين المحلي ------ **/
  const S = {
    children: JSON.parse(localStorage.getItem('children')||'{}'),
    specialists: JSON.parse(localStorage.getItem('specialists')||'{}'),
    appointments: JSON.parse(localStorage.getItem('appointments')||'{}'),
  };
  const packages = {
    "24":{weekly:2,total:24,days:["Saturday","Wednesday"]},
    "36":{weekly:3,total:36,days:["Saturday","Monday","Thursday"]},
    "48":{weekly:4,total:48,days:["Saturday","Monday","Wednesday","Friday"]},
    "psychology":{weekly:1,total:1,days:["Saturday"]},
    "iq":{weekly:1,total:1,days:["Saturday"]}
  };
  const slots=["13:00","15:20","17:40"];
  function sync(){ 
    localStorage.setItem('children',JSON.stringify(S.children));
    localStorage.setItem('specialists',JSON.stringify(S.specialists));
    localStorage.setItem('appointments',JSON.stringify(S.appointments));
  }

  /** ------ تبويبات ------ **/
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  $$( 'nav button').forEach(b=>{
    b.onclick=()=>{
      $$('nav button').forEach(x=>x.classList.remove('active'));
      $$('section').forEach(sec=>sec.classList.remove('active'));
      b.classList.add('active');
      $('#'+b.dataset.tab).classList.add('active');
      if(b.dataset.tab==='reports') renderReports();
    };
  });

  /** ------ إعادة العرض ------ **/
  function renderChildren(){
    let tb=$('#tblChildren tbody'); tb.innerHTML='';
    Object.entries(S.children).forEach(([id,ch],i)=>{
      tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${ch.name}</td><td>${ch.package}</td><td>${ch.startDate}</td>
        <td>${packages[ch.package].total}</td><td>${ch.remaining}</td><td>${ch.status}</td>
        <td>
          <button onclick="openModal('child','${id}')">تعديل</button>
          <button onclick="deleteChild('${id}')">حذف</button>
        </td>
      </tr>`;
    });
  }
  function renderSpecs(){
    let tb=$('#tblSpecs tbody'); tb.innerHTML='';
    Object.entries(S.specialists).forEach(([id,sp],i)=>{
      tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${sp.name}</td><td>${sp.section}</td><td>${sp.workingDays.join(',')}</td>
        <td>
          <button onclick="openModal('spec','${id}')">تعديل</button>
          <button onclick="deleteSpec('${id}')">حذف</button>
        </td>
      </tr>`;
    });
  }
  function renderAppts(){
    let tb=$('#tblAppts tbody'); tb.innerHTML='';
    Object.entries(S.appointments).forEach(([id,a],i)=>{
      let ch=S.children[a.childId]?.name||'–';
      let sp=S.specialists[a.specId]?.name||'–';
      tb.innerHTML+=`
      <tr>
        <td>${i+1}</td><td>${ch}</td><td>${a.date}</td><td>${a.time}</td>
        <td>${a.section}</td><td>${sp}</td><td>${a.type}</td><td>${a.status}</td>
        <td>
          ${a.status==='scheduled'?`<button onclick="markAbsent('${id}')">غاب</button>`:''}
          <button onclick="openModal('appt','${id}')">تعديل</button>
          <button onclick="deleteAppt('${id}')">حذف</button>
          ${a.status==='absent'?`<button onclick="makeup('${id}')">تعويض</button>`:''}
        </td>
      </tr>`;
    });
  }
  function renderReports(){
    let end=Object.values(S.children)
      .filter(c=>c.status==='active'&&c.remaining<=packages[c.package].weekly)
      .map(c=>`<li>${c.name} (${c.remaining})</li>`).join('')||'<li>لا أحد</li>';
    let paused=Object.values(S.children)
      .filter(c=>c.status==='paused')
      .map(c=>`<li>${c.name}</li>`).join('')||'<li>لا أحد</li>';
    $('#endingReport').innerHTML=`<h3>قريب الانتهاء:</h3><ul>${end}</ul>`;
    $('#pausedReport').innerHTML=`<h3>متوقفون:</h3><ul>${paused}</ul>`;
  }

  /** ------ CRUD ------ **/
  function deleteChild(id){
    if(!confirm('حذف طفل؟'))return;
    delete S.children[id]; sync(); renderChildren();
  }
  function deleteSpec(id){
    if(!confirm('حذف أخصائي؟'))return;
    delete S.specialists[id]; sync(); renderSpecs();
  }
  function deleteAppt(id){
    if(!confirm('حذف موعد؟'))return;
    let a=S.appointments[id];
    if(a.type==='regular') S.children[a.childId].remaining++;
    delete S.appointments[id]; sync(); renderAppts(); renderChildren();
  }
  function markAbsent(id){
    S.appointments[id].status='absent';
    S.children[S.appointments[id].childId].remaining++;
    sync(); renderAppts(); renderChildren();
  }
  function makeup(id){ autoScheduleChild(S.appointments[id].childId,{type:'makeup'}); }

  /** ------ مودال ------ **/
  let mType,mId;
  function openModal(type,id=null){
    mType=type; mId=id;
    $('#modalTitle').innerText=(id?'تعديل ':'إضافة ')+{child:'طفل',spec:'أخصائي',appt:'موعد'}[type];
    let f=$('#modalForm'); f.innerHTML='';
    let d=id?(type==='child'?S.children[id]:(type==='spec'?S.specialists[id]:S.appointments[id])):{};
    if(type==='child'){
      f.innerHTML=`
        <label>اسم: <input name="name" value="${d.name||''}"/></label>
        <label>بكيج:
          <select name="package">
            ${Object.keys(packages).map(k=>`<option ${k===d.package?'selected':''} value="${k}">${k}</option>`).join('')}
          </select>
        </label>
        <label>بدء: <input type="date" name="startDate" value="${d.startDate||''}"/></label>
        <label>حالة:
          <select name="status">
            <option ${d.status==='active'?'selected':''} value="active">نشط</option>
            <option ${d.status==='paused'?'selected':''} value="paused">متوقف</option>
          </select>
        </label>`;
    }
    if(type==='spec'){
      f.innerHTML=`
        <label>اسم: <input name="name" value="${d.name||''}"/></label>
        <label>قسم:
          <select name="section">
            <option value="speech">تخاطب</option>
            <option value="behavior">سلوك</option>
            <option value="skills">مهارات</option>
            <option value="psychology">نفسية</option>
            <option value="iq">ذكاء</option>
          </select>
        </label>
        <label>أيام (مثل: Saturday,Monday):
          <input name="workingDays" value="${(d.workingDays||[]).join(',')}"/>
        </label>`;
    }
    if(type==='appt'){
      f.innerHTML=`
        <label>طفل:
          <select name="childId">
            ${Object.entries(S.children).map(([cid,ch])=>`<option ${cid===d.childId?'selected':''} value="${cid}">${ch.name}</option>`).join('')}
          </select>
        </label>
        <label>قسم:
          <select name="section">
            ${Object.keys(packages).map(k=>`<option ${k===d.section?'selected':''} value="${k}">${k}</option>`).join('')}
          </select>
        </label>
        <label>تاريخ: <input type="date" name="date" value="${d.date||''}"/></label>
        <label>وقت:
          <select name="time">
            ${slots.map(t=>`<option ${t===d.time?'selected':''} value="${t}">${t}</option>`).join('')}
          </select>
        </label>
        <label>نوع:
          <select name="type">
            <option ${d.type==='regular'?'selected':''} value="regular">عادي</option>
            <option ${d.type==='makeup'?'selected':''} value="makeup">تعويض</option>
          </select>
        </label>`;
    }
    $('#modal').style.display='flex';
  }
  function closeModal(e){ e.preventDefault(); $('#modal').style.display='none'; }
  function saveModal(e){
    e.preventDefault();
    let fm=new FormData($('#modalForm')), o={};
    for(let [k,v] of fm.entries()) o[k]=v;
    if(mType==='child'){
      if(!mId){ mId=Date.now().toString(); o.remaining=packages[o.package].total; }
      S.children[mId]=o; renderChildren();
    }
    if(mType==='spec'){
      if(!mId) mId=Date.now().toString();
      o.workingDays=o.workingDays.split(',').map(x=>x.trim());
      S.specialists[mId]=o; renderSpecs();
    }
    if(mType==='appt'){
      if(!mId){
        mId=Date.now().toString();
        if(o.type==='regular') S.children[o.childId].remaining--;
      }
      S.appointments[mId]={...o,status:'scheduled'}; renderAppts(); renderChildren();
    }
    sync(); closeModal(e);
  }

  /** ------ الجدولة التلقائية ------ **/
  function nextDate(day){
    const map={Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};
    let t=new Date(), d=(map[day]-t.getDay()+7)%7||7;
    let r=new Date(t.getFullYear(),t.getMonth(),t.getDate()+d);
    return r.toISOString().split('T')[0];
  }
  function autoScheduleChild(cid,opts={type:'regular'}){
    let ch=S.children[cid], pkg=packages[ch.package], need=pkg.weekly;
    for(let day of pkg.days){
      if(need===0)break;
      let date=nextDate(day);
      for(let time of slots){
        if(need===0)break;
        let entry=Object.entries(S.specialists).find(([i,sp])=>sp.section===ch.package && sp.workingDays.includes(day));
        if(!entry) continue;
        let [spid]=entry;
        if(Object.values(S.appointments).some(a=>a.specId===spid && a.date===date && a.time===time)) continue;
        let aid=Date.now().toString()+Math.random();
        S.appointments[aid]={childId:cid,specId:spid,section:ch.package,date,time,type:opts.type,status:'scheduled'};
        if(opts.type==='regular'){ ch.remaining--; need--; }
      }
    }
    sync(); renderAppts(); renderChildren();
  }
  function autoScheduleAll(){
    Object.keys(S.children).forEach(cid=>{
      if(S.children[cid].status==='active') autoScheduleChild(cid);
    });
  }

  // بدء العرض
  renderChildren(); renderSpecs(); renderAppts();
  </script>

</body>
</html>
